光源位置再構成プログラム (Reconstructor) 仕様書
1. 概要
本プログラム reconstructor は、ROOT形式の実験データ（PMTの電荷・時間情報）を入力として、光源の3次元位置 (x,y,z) および発光時刻 t 
0
​
  を再構成（フィッティング）します。 観測データと物理モデルから計算される期待値との残差（χ 
2
  または尤度）を最小化することで、最適なパラメータを探索します。

2. 実行方法
コマンドライン
Bash

./reconstructor <入力ROOTファイル> [オプション]
オプション一覧
オプション	引数	説明	デフォルト
-u	0 or 1	
Unhit救済モード


0: 4本すべてのPMTがヒットしたイベントのみ解析


1: 3本ヒットの場合、残り1本を電荷0として補完して解析

0
-m	model	
電荷期待値モデルの選択


func_f: 半径28.5cmモデル（立体角近似）


func_g: 半径23.5cmモデル（1/r 
2
 ）

func_f
-q	type	
電荷のChi2計算タイプ


gaus: ガウス分布


bc: Baker-Cousins (ポアソン尤度比)


none: 電荷情報を使用しない

gaus
-t	type	
時間のChi2計算タイプ


gaus: ガウス分布


goodness: SK風Goodness


none: 時間情報を使用しない

gaus

Google スプレッドシートにエクスポート

3. 内部ロジック詳細
フィッティングでは、以下の物理モデルを用いて期待値を計算します。

3.1 ジオメトリ定義
PMTの座標は以下のように定義されます。

X, Y座標: 全モデル共通（fittinginput.hh で定義）。

CH0: (-35.0, 35.0), CH1: (35.0, 35.0), CH2: (-35.0, -35.0), CH3: (35.0, -35.0)

Z座標 (中心): モデルによって変動します。

基準表面高さ: Z 
surf
​
 =80.5 cm

FuncF (r 
pmt
​
 =28.5): Z 
center
​
 =80.5−28.5=52.0 cm

FuncG (r 
pmt
​
 =23.5): Z 
center
​
 =80.5−23.5=57.0 cm

3.2 距離の計算
解析では2種類の距離が使用されます。

中心距離 (r): 光源 (x,y,z) から PMT球中心 (x 
p
​
 ,y 
p
​
 ,Z 
center
​
 ) までの距離。

r= 
(x−x 
p
​
 ) 
2
 +(y−y 
p
​
 ) 
2
 +(z−Z 
center
​
 ) 
2
 

​
 
表面距離 (d 
surf
​
 ): 光源からPMT表面までの最短距離（Time of Flight計算用）。

d 
surf
​
 =r−r 
pmt
​
 
3.3 電荷期待値モデル (μ)
パラメータ A (光量係数) を用いて以下のように計算されます。B (バックグラウンド) は常に 0 に固定されます。

モデル: func_f (デフォルト)
PMT半径: r 
pmt
​
 =28.5 cm

期待値:

μ=A⋅c 
0,f
​
 ⋅(1− 
1−( 
r
r 
pmt
​
 
​
 ) 
2
 

​
 )⋅ϵ(cosα)
※ (r 
pmt
​
 /r) 
2
 ≥1 (光源がPMT内) の場合は、立体角の最大値係数 c 
0,f
​
  を使用します。

モデル: func_g
PMT半径: r 
pmt
​
 =23.5 cm

期待値:

μ=A⋅ 
r 
2
 
c 
0,g
​
 
​
 ⋅ϵ(cosα)
ここで、c 
0
​
  はチャンネルごとの感度補正係数、ϵ(cosα) は入射角 α に対する角度依存性関数（多項式）です。

3.4 時間期待値モデル (t 
exp
​
 )
t 
exp
​
 =t 
0
​
 + 
c
d 
surf
​
 
​
 +TW(Q)+T 
corr
​
 
t 
0
​
 : 発光時刻パラメータ

d 
surf
​
 /c: 飛行時間（c≈30 cm/ns）

TW(Q): TimeWalk補正（電荷依存）

T 
corr
​
 : ケーブル遅延等の定数補正

4. 出力ファイル仕様
4.1 ファイル命名規則
入力ファイル名と実行オプションに基づいて自動生成されます。 形式: [BaseName]_reconst_[HitMode]_[Q_Chi2]_[Q_Model]_[T_Chi2].csv

例: run001_reconst_3hits_bc_func_f_gausT.csv

4.2 CSVヘッダー詳細
出力CSVファイルは以下のカラムを持ちます。

列名	説明	備考
fit_x	再構成された光源のX座標 (cm)	
fit_y	再構成された光源のY座標 (cm)	
fit_z	再構成された光源のZ座標 (cm)	
t_light	再構成された発光時刻 (ns)	オプション -t none 時は -9999
err_x	X座標のフィッティング誤差	
err_y	Y座標のフィッティング誤差	
err_z	Z座標のフィッティング誤差	
err_t	時刻のフィッティング誤差	オプション -t none 時は -9999
chi2	最小化された χ 
2
  の値	
ndf	自由度 (データ点数 - パラメータ数)	
A	光量パラメータ	オプション -q none 時は -9999
B	バックグラウンドパラメータ	今回のモデルでは常に 0 (または -9999)
status	Minuitの収束ステータス	3: 正常収束, それ以外: 失敗等の可能性

Google スプレッドシートにエクスポート