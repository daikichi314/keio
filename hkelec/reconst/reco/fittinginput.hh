/**
 * @file fittinginput.hh
 * @brief フィッティングに必要な定数、データ構造、設定構造体を定義するヘッダーファイル
 *
 * このファイルには以下の要素が含まれます：
 * 1. 物理定数 (光速など)
 * 2. 検出器ジオメトリ定義 (PMT座標、向き)
 * 3. 補正パラメータ (TimeWalk, TimeOffset, 電荷モデル係数)
 * 4. 入力データの構造体 (PMTData)
 * 5. 解析設定用の列挙型と構造体 (FitConfig)
 *
 * @author Gemini (Modified based on user request)
 * @date 2025-01-08
 */

#ifndef FITTINGINPUT_HH
#define FITTINGINPUT_HH

#include <vector>
#include <cmath>
#include <string>

// time csv files ============================================================================================================
// min_val = TIME_CORRECTION_VAL 
// MeanがTimewalk、RMSが時間分解能のフィットに使用されるパラメータに対応
    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 0,Gamma,-2.97248e+11,1902.59,1.63159e+11,5.54198e+10,-7.86906e+09,5.45736e+10,1.27231e+08,5.48893e+10,4.05153e+07,11,-8.83371e+10,1.64538e+11,1.53786
    // 0,GausAmp,-48881.5,127.58,29985.8,49.1926,-28.3817,0.0611268,0.0082181,2.06855e-05,111917,24,-9475.15,0,1.53786
    // 0,GausMu,19.6289,0.0162468,193.683,0.00251109,-0.0054264,6.85525e-06,1.92106e-06,5.31769e-09,120552,16,190.37,0,1442.4
    // 0,GausSigma,2.64048,0.00659496,0.106235,0.00119835,0.000178009,3.59899e-06,-2.89345e-08,2.81415e-09,2044.75,16,0.304737,0,419.347
    // 0,Mean,19.8842,0.0170032,193.657,0.00270831,-0.00556375,7.47335e-06,1.95876e-06,5.75591e-09,107397,16,190.23,0,1442.4
    // 0,Mu,7.43826,0.00684796,196.653,0.00153344,-0.0309401,1.3014e-06,6.50566e-06,4.50743e-10,1.18948e+06,11,160.019,0.000963488,2380.4
    // 0,Peak,8.81294,0.021167,196.783,0.00475129,-0.0319055,2.03357e-05,7.06731e-06,8.9119e-09,15528,11,160.959,0,2260.16
    // 0,RMS,3.58786,0.00723263,0.0025788,0.00133038,0.000733431,4.33215e-06,-2.4322e-07,3.60742e-09,10815.8,16,0.393235,0,199.558
    // 0,Sigma,0.665964,0.000741858,0.586454,0.000303666,-0.00614516,6.96973e-06,3.90689e-06,4.11964e-09,5.18883e+06,11,-1.80625,0.00784484,788.377
    // 0,TTS,6.96942,0.0213118,-0.147895,0.0048441,0.00608534,1.95824e-05,-2.19157e-06,8.60325e-09,4856.74,11,1.10022,0,71.43
    // 0,Tau,6.45372,0.0029152,-1.00634,0.000407207,0.00550268,1.00038e-06,-2.0886e-06,5.71144e-10,181140,11,-0.368193,0,2538.42

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 1,Gamma,1.14075e+10,8.60828e+06,5.80783e+08,349932,-2.34661e+13,8.21207e+09,8.73611e+12,1.5411e+08,5.63769e+07,13,-1.39663e+13,0,1.79477
    // 1,GausAmp,-52202.6,137.679,30986.1,52.4106,-32.4405,0.0643751,0.0102357,2.11635e-05,123700,24,-8038.28,0,1.79477
    // 1,GausMu,19.2141,0.0193678,216.759,0.00303062,-0.00552248,8.66071e-06,2.06143e-06,7.30099e-09,72137.1,12,213.65,0,1206.35
    // 1,GausSigma,2.56711,0.0068221,0.100237,0.00130237,0.000182068,4.25517e-06,-3.5941e-08,3.72584e-09,2896.62,14,0.295619,0,414.138
    // 1,Mean,19.5672,0.0197772,216.73,0.00318416,-0.00564927,9.44224e-06,2.11823e-06,8.26361e-09,57737.2,12,213.561,0,1206.35
    // 1,Mu,19.3633,0.0159084,217.623,0.00248714,-0.028414,1.83272e-06,5.99612e-06,4.5879e-10,4.26924e+06,13,184.359,0.00102911,2376.33
    // 1,Peak,16.1198,0.0212362,218.537,0.0039881,-0.0294556,1.25358e-05,6.41677e-06,5.36177e-09,298378,13,185.07,0,2300.89
    // 1,RMS,3.87657,0.00801372,-0.0606388,0.00148629,0.000770614,5.24429e-06,-2.04928e-07,5.00895e-09,8101.8,14,0.3594,0,199.294
    // 1,Sigma,0.567919,0.000649625,0.595513,0.000269288,-0.00625425,6.18503e-06,4.61585e-06,4.20395e-09,1.00653e+07,13,-1.50123,0.00929052,679.213
    // 1,TTS,7.16692,0.0205389,-0.241254,0.00425874,0.0057971,1.43513e-05,-2.12198e-06,6.21276e-09,10885.5,13,0.93839,0,2539.41
    // 1,Tau,8.85492,0.00409106,-1.43884,0.000532892,0.00740935,1.08274e-06,-3.2484e-06,6.48678e-10,1.62525e+06,13,-3.39536,0.000510264,2539.41

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 2,Gamma,-3.18479e+15,7.17777e+12,1.02512e+16,2.31035e+13,-3.50325e+15,7.89541e+12,2.97696e+14,6.7093e+11,4.72391e+07,11,-1.3792e+15,0,5.68671
    // 2,GausAmp,-56353,149.172,32437.7,54.254,-30.4397,0.0627617,0.00843304,1.98912e-05,122273,24,-9696.88,0,1.79342
    // 2,GausMu,19.035,0.0171755,220.41,0.00260978,-0.00475051,6.60352e-06,1.55778e-06,4.6165e-09,108440,15,217.272,0,1573.7
    // 2,GausSigma,2.64227,0.00696015,0.0973153,0.00119871,0.000182438,3.20551e-06,-1.76233e-08,2.23726e-09,3740.74,15,0.299575,0,394.622
    // 2,Mean,19.2426,0.0173597,220.392,0.00273355,-0.00496091,7.08632e-06,1.59961e-06,5.01004e-09,89502.3,15,217.03,0,1597.76
    // 2,Mu,14.6184,1,221.533,1.00209,-0.0126188,1.00214,-2.05122e-06,1.00214,2.95318e+06,11,176.457,3.47344e+06,2543.52
    // 2,Peak,11.1175,0.0214288,222.357,0.0046204,-0.0172871,2.54264e-05,8.38212e-07,1.0971e-08,414883,11,184.03,0.0252531,2543.52
    // 2,RMS,3.65513,0.0077786,0.001132,0.00140131,0.000849763,4.22716e-06,-2.34409e-07,3.2028e-09,12513.1,15,0.418925,0,178.542
    // 2,Sigma,5.76789e+08,405962,-9.19536e+07,64048.9,76191.3,54.0336,-18.1941,0.0131397,2.48965e+06,11,-3.76089e+07,27541.9,265.893
    // 2,TTS,7.3334,0.0238083,-0.350955,0.00572208,0.0091899,3.41278e-05,-3.44737e-06,1.44196e-08,14312.2,11,0.866436,0,2543.52
    // 2,Tau,3.9762e+08,348785,-1.00858e+08,82177.6,889477,698.066,-441.087,0.348889,4.12992e+06,11,-6.84181e+08,573733,2543.52

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 3,Gamma,9.80067e+10,2.61576e+13,-9.06968e+17,2.18476e+15,-2.12503e+20,4.12005e+16,4.50962e+21,1.7207e+17,1.73343e+07,8,1.59246e+22,0,1.90292
    // 3,GausAmp,-48535.2,130.035,28362.3,48.2055,-25.6037,0.0578397,0.00678732,1.8773e-05,73241,22,-6870.53,0,1.90292
    // 3,GausMu,18.66,0.0182492,246.961,0.00294303,-0.00550003,8.1478e-06,1.78382e-06,6.1501e-09,80593.3,15,243.193,0,1583.16
    // 3,GausSigma,2.74712,0.00797341,0.126977,0.00141738,0.000133321,3.98505e-06,7.79254e-08,2.9565e-09,4122.62,15,0.329787,0,372.153
    // 3,Mean,18.7813,0.0190264,246.941,0.0032899,-0.00594045,9.37393e-06,1.83122e-06,6.90607e-09,61810.6,15,242.587,0,1659.91
    // 3,Mu,7.85131,0.00903362,249.461,0.00236698,-0.027871,6.74708e-06,5.23753e-06,2.95963e-09,221152,8,212.623,0.00655169,2533.76
    // 3,Peak,10.0401,0.0262667,249.337,0.00673509,-0.0263838,3.70715e-05,4.76355e-06,1.59542e-08,14061.4,8,213.267,0,2533.76
    // 3,RMS,3.59905,0.00880967,0.0923478,0.00174692,0.00125586,5.72697e-06,-2.98823e-07,4.48469e-09,9549.26,15,0.566168,0,132.751
    // 3,Sigma,7.16042e+08,241454,-1.49307e+08,14487.6,127470,2.85674,-30.216,0.00319919,1.1429e+06,8,-7.44645e+07,0,213.766
    // 3,TTS,6.76826,0.0319104,-0.0125329,0.00889587,0.00871357,4.11186e-05,-3.2036e-06,1.77118e-08,5883.31,8,1.36964,0,54.7085
    // 3,Tau,1.53515,0.00625523,1.35509,0.0034182,-0.0497263,0.000105495,2.61584e-05,5.38866e-08,1.14402e+06,8,-22.2271,0.0634662,950.984
// time csv files ============================================================================================================

// =========================================================
// 物理定数・PMT補正値
// =========================================================
const double C_LIGHT = 29.970255; // 光速 [cm/ns] (空気中の屈折率 n=1.0003 を考慮)

// PMTごとの時間補正値 (ns) : ケーブル遅延やT0オフセット
// t_expected の計算に使用されます: t_exp = t0 + tof + TW + CORRECTION
const double TIME_CORRECTION_VAL[4] = {190.23, 213.561, 217.03, 242.587};
const double TIME_CORRECTION_ERR[4] = {0.0, 0.0, 0.0, 0.0};

// =========================================================  
// TimeWalk (TW) および 時間分解能 (Sigma_t) のパラメータ
// =========================================================
// 関数形: f(q) = c0 * q^{-1/2} + c1 + c2 * q + c3 * q^2
// 配列の並び: {c0, c1, c2, c3}

// TimeWalk補正係数 [ch][param]
// 上のCSVデータから取得したフィットパラメータを使用 (Meanのデータからc0~c3)
const double TW_PARAMS[4][4] = {
    {19.8842, 193.657-TIME_CORRECTION_VAL[0], -0.00556375, 1.95876e-06}, // CH0
    {19.5672, 216.73-TIME_CORRECTION_VAL[1], -0.00564927, 2.11823e-06}, // CH1
    {19.2426, 220.392-TIME_CORRECTION_VAL[2], -0.00496091, 1.59961e-06}, // CH2
    {18.7813, 246.941-TIME_CORRECTION_VAL[3], -0.00594045, 1.83122e-06}  // CH3
};

// TimeWalk補正の上限値 [ch] (ns)
// TW(q)が計算されたとき、この値を超える場合は上限値が使用されます
const double TW_MAX_VALUES[4] = {
    14.25, // CH0: 上限値 (適切な値に調整してください)
    13.31, // CH1: 上限値 (適切な値に調整してください)
    13.39, // CH2: 上限値 (適切な値に調整してください)
    14.22  // CH3: 上限値 (適切な値に調整してください)
};

// 時間分解能 (Sigma_t) 係数 [ch][param]
// 上のCSVデータから取得したフィットパラメータを使用 (RMSのデータからc0~c3)
const double SIGMA_T_PARAMS[4][4] = {
    {3.58786, 0.0025788, 0.000733431, -2.4322e-07}, // CH0
    {3.87657, -0.0606388, 0.000770614, -2.04928e-07}, // CH1
    {3.65513, 0.001132, 0.000849763, -2.34409e-07}, // CH2
    {3.59905, 0.0923478, 0.00125586, -2.98823e-07}  // CH3
};

// =========================================================
// [New] 電荷モデル用パラメータ
// =========================================================

// --- Model: FuncF 用パラメータ (PMT半径 28.5cm) ---
// 式: mu = A * c0 * (1 - sqrt(1 - (28.5/r)^2)) * epsilon
// 配列: {c0} (各CHごとのスケール因子)

    // ====================================================================================================
    // フィット結果 (r_pmt = 29.0 cm, z_center = 51.5 cm)
    // ====================================================================================================
    //  PMT_num  n_data  r_pmt  z_pmt_center        f_c0  f_c0_err  f_chi2_ndf         g_c0   g_c0_err   g_chi2_ndf
    //        1      28   29.0          51.5 1686.432523  0.432670 1150.691856 7.484976e+05 192.487230  3796.303364
    //        2      32   29.0          51.5 1767.050812  0.324612 1358.436845 8.012284e+05 147.754970  8681.334816
    //        3      34   29.0          51.5 2257.784746  0.384065 5659.065835 1.022391e+06 174.464923 12242.251193
    //        4      32   29.0          51.5 2017.263074  0.349612 1569.650918 9.243634e+05 160.324212  3215.532997
    // ====================================================================================================

const double CHARGE_RADIAL_PARAMS_FUNC_F[4] = {
    1686.432523, // CH0
    1767.050812, // CH1
    2257.784746, // CH2
    2017.263074  // CH3
};

// 角度依存性: epsilon_i(cos_a) = c0 + c1*x + ... + c7*x^7
// 配列: {c0, c1, c2, c3, c4, c5, c6, c7}

const double CHARGE_ANGULAR_PARAMS_FUNC_F[4][8] = {
    {135.10349511, -1538.07564554, 7299.25832960, -18682.85503414, 27913.19328536, -24378.60890292, 11538.72013868, -2285.73566615}, // CH0 (PMT1)
    {2.91703927, -19.44876903, 68.54078255, -142.38001954, 182.81937855, -125.73409148, 30.29164251, 3.99403717}, // CH1 (PMT2)
    {-55.25152513, 699.43849228, -3657.34100011, 10321.99783138, -16999.97466495, 16374.07074879, -8558.93293251, 1876.99305024}, // CH2 (PMT3)
    {75.80759799, -894.50453564, 4407.04245524, -11730.78934507, 18271.05963028, -16685.14366368, 8288.66803947, -1731.14017858}  // CH3 (PMT4)
};


// --- Model: FuncG 用パラメータ (PMT半径 23.5cm) ---
// 式: mu = A * c0 / r^2 * epsilon
// 配列: {c0} (各CHごとのスケール因子)

    // ====================================================================================================
    // フィット結果 (r_pmt = 24.0 cm, z_center = 56.5 cm)
    // ====================================================================================================
    //  PMT_num  n_data  r_pmt  z_pmt_center        f_c0  f_c0_err   f_chi2_ndf          g_c0   g_c0_err  g_chi2_ndf
    //        1      28   24.0          56.5 2132.023311  0.547325  1837.443742 647390.542942 166.065333  955.109254
    //        2      32   24.0          56.5 2180.368988  0.401011  3604.308571 678599.420934 124.657860 1316.004210
    //        3      34   24.0          56.5 2791.721585  0.475842  9843.129549 868742.831124 147.755759 5328.779907
    //        4      32   24.0          56.5 2463.041748  0.428677 10608.722147 774513.718926 134.211547 1260.158058
    // ====================================================================================================
const double CHARGE_RADIAL_PARAMS_FUNC_G[4] = {
    647390.542942, // CH0
    678599.420934, // CH1
    868742.831124, // CH2
    774513.718926  // CH3
};

// 角度依存性: epsilon_i(cos_a) = c0 + c1*x + ... + c7*x^7
// 配列: {c0, c1, c2, c3, c4, c5, c6, c7}

const double CHARGE_ANGULAR_PARAMS_FUNC_G[4][8] = {
    {71.39814903, -877.62054121, 4476.55415513, -12219.27002402, 19344.29237783, -17805.88358643, 8843.38992722, -1831.86045754}, // CH0 (PMT1)
    {19.35704875, -224.40998325, 1119.68804980, -3032.93540071, 4813.40418581, -4464.44537749, 2237.90010695, -467.55862985}, // CH1 (PMT2)
    {-10.62954480, 166.15318500, -1009.06682605, 3230.33143065, -5912.31795787, 6227.43154368, -3515.02028297, 824.11845236}, // CH2 (PMT3)
    {27.90789763, -360.05146960, 1929.50345307, -5518.05534054, 9143.68676866, -8809.52402553, 4585.16754806, -997.63483176}  // CH3 (PMT4)
};

/*
========================================================================================================================
f関数 - 方法B（再パラメータ化）：全パラメータ表
========================================================================================================================


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT ALL (f関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 1064
χ²/ndf: 5491.826403
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ              値         誤差
   c0    27.19957061 1.8575e+02
   c1  -297.26027332 5.9780e+00
   c2  1360.78310773 2.8938e+01
   c3 -3336.55586353 7.6000e+01
   c4  4740.51458060 1.1714e+02
   c5 -3896.72108189 1.0614e+02
   c6  1711.10742560 5.2409e+01
   c7  -308.06746580 1.0895e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 1 (f関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 3219.274821
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ               値         誤差
   c0    135.10349511 4.5715e+02
   c1  -1538.07564554 1.4760e+01
   c2   7299.25832960 7.1386e+01
   c3 -18682.85503414 1.8730e+02
   c4  27913.19328536 2.8840e+02
   c5 -24378.60890292 2.6101e+02
   c6  11538.72013868 1.2875e+02
   c7  -2285.73566615 2.6736e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 2 (f関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 3474.572996
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ             値         誤差
   c0    2.91703927 3.9266e+02
   c1  -19.44876903 1.2768e+01
   c2   68.54078255 6.1615e+01
   c3 -142.38001954 1.6131e+02
   c4  182.81937855 2.4785e+02
   c5 -125.73409148 2.2385e+02
   c6   30.29164251 1.1020e+02
   c7    3.99403717 2.2839e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 3 (f関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 4607.339966
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ               値         誤差
   c0    -55.25152513 3.3944e+02
   c1    699.43849228 1.0916e+01
   c2  -3657.34100011 5.2849e+01
   c3  10321.99783138 1.3883e+02
   c4 -16999.97466495 2.1405e+02
   c5  16374.07074879 1.9399e+02
   c6  -8558.93293251 9.5829e+01
   c7   1876.99305024 1.9930e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 4 (f関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 2876.159894
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ               値         誤差
   c0     75.80759799 3.3900e+02
   c1   -894.50453564 1.0815e+01
   c2   4407.04245524 5.2494e+01
   c3 -11730.78934507 1.3824e+02
   c4  18271.05963028 2.1364e+02
   c5 -16685.14366368 1.9407e+02
   c6   8288.66803947 9.6072e+01
   c7  -1731.14017858 2.0020e+01


========================================================================================================================
g関数 - 方法B（再パラメータ化）：全パラメータ表
========================================================================================================================


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT ALL (g関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 1064
χ²/ndf: 5516.343201
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ              値         誤差
   c0    19.67191184 1.0948e+02
   c1  -235.82668540 2.9623e+00
   c2  1187.57132900 1.5239e+01
   c3 -3191.85585584 4.2231e+01
   c4  4966.82255981 6.8258e+01
   c5 -4481.32972888 6.4489e+01
   c6  2173.48882651 3.3048e+01
   c7  -437.54235704 7.0999e+00


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 1 (g関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 3305.706648
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ               値         誤差
   c0     71.39814903 2.7139e+02
   c1   -877.62054121 7.3770e+00
   c2   4476.55415513 3.7900e+01
   c3 -12219.27002402 1.0489e+02
   c4  19344.29237783 1.6929e+02
   c5 -17805.88358643 1.5972e+02
   c6   8843.38992722 8.1738e+01
   c7  -1831.86045754 1.7537e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 2 (g関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 3452.350473
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ              値         誤差
   c0    19.35704875 2.2600e+02
   c1  -224.40998325 6.1732e+00
   c2  1119.68804980 3.1665e+01
   c3 -3032.93540071 8.7505e+01
   c4  4813.40418581 1.4104e+02
   c5 -4464.44537749 1.3289e+02
   c6  2237.90010695 6.7921e+01
   c7  -467.55862985 1.4554e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 3 (g関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 4591.630626
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ              値         誤差
   c0   -10.62954480 1.9996e+02
   c1   166.15318500 5.4016e+00
   c2 -1009.06682605 2.7799e+01
   c3  3230.33143065 7.7078e+01
   c4 -5912.31795787 1.2465e+02
   c5  6227.43154368 1.1783e+02
   c6 -3515.02028297 6.0423e+01
   c7   824.11845236 1.2990e+01


────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
PMT 4 (g関数)
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
データ点数: 266
χ²/ndf: 2886.903063
制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング

【パラメータ (c0~c7)】
パラメータ              値         誤差
   c0    27.90789763 2.0210e+02
   c1  -360.05146960 5.4257e+00
   c2  1929.50345307 2.7978e+01
   c3 -5518.05534054 7.7718e+01
   c4  9143.68676866 1.2591e+02
   c5 -8809.52402553 1.1923e+02
   c6  4585.16754806 6.1234e+01
   c7  -997.63483176 1.3183e+01


========================================================================================================================
方法B：全結果表示完了
========================================================================================================================
*/


// =========================================================
// PMT座標・形状定義 (4 PMTs)
// =========================================================
// X, Y座標は表面中心・半球中心で共通 (軸対称と仮定)
const double PMT_XY_POS[4][2] = {
    {-35.0,  35.0}, // PMT#1 (CH0)
    { 35.0,  35.0}, // PMT#2 (CH1)
    {-35.0, -35.0}, // PMT#3 (CH2)
    { 35.0, -35.0}  // PMT#4 (CH3)
};

// 基準となる表面の高さ (cm)
// ※ 中心座標はここから半径 r_pmt を引いて計算される
const double PMT_SURFACE_Z = 80.5;

// モデルごとのPMT半径定義 (cm)
const double PMT_RADIUS_F = 29.0; // func_f 用
const double PMT_RADIUS_G = 24.0; // func_g 用

// PMTの向き (全PMT共通でZ軸方向を向いていると仮定)
const double PMT_DIR[3] = {0.0, 0.0, 1.0}; 

// 便宜上の旧互換定義 (readDataなどで使用される表面中心座標)
const double PMT_POSITIONS[4][3] = {
    {-35.0,  35.0, PMT_SURFACE_Z},
    { 35.0,  35.0, PMT_SURFACE_Z},
    {-35.0, -35.0, PMT_SURFACE_Z},
    { 35.0, -35.0, PMT_SURFACE_Z}
};

// =========================================================
// 関数プロトタイプ
// =========================================================
// チャンネルと電荷を受け取り、パラメータ配列に基づいて値を計算する関数
double CalcParametricValue(int ch, double charge, const double params[4][4]);

// 以下、旧来の関数（必要に応じて中身を書き換え予定だが今回は上記関数で代替）
double GetEMG_Sigma(int ch, double charge);
double GetEMG_Tau(int ch, double charge);

// =========================================================
// データ構造体
// =========================================================
struct PMTData {
    int eventID;
    int ch;
    double time;
    double charge;
    double x, y, z; // 読み込み時の座標 (通常は表面中心が入る)
    double dir_x, dir_y, dir_z;
    bool isHit;
};

struct PedestalData {
    double hgain_mean;
    double lgain_mean;
};

// =========================================================
// フィッティング設定
// =========================================================

/**
 * @enum ChargeChi2Type
 * @brief 電荷分布のChi2計算モデル
 */
enum class ChargeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    BakerCousins,   // 2 * (mu - n + n*ln(n/mu))
    None            // 電荷情報を使用しない
};

/**
 * @enum ChargeModelType
 * @brief 電荷の期待値モデル
 * @note 古いモデルは削除され、FuncF, FuncGのみとなりました。
 */
enum class ChargeModelType {
    FuncF,          // r=28.5, 立体角近似式
    FuncG           // r=23.5, 1/r^2
};

/**
 * @enum TimeChi2Type
 * @brief 時間分布のChi2計算モデル
 */
enum class TimeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    EMG,            // EMG分布 (-ln L)
    Goodness,       // SK風Goodness
    None            // 時間情報を使用しない
};

struct FitConfig {
    ChargeChi2Type chargeType = ChargeChi2Type::Gaussian;
    ChargeModelType chargeModel = ChargeModelType::FuncF; // デフォルト
    TimeChi2Type timeType = TimeChi2Type::Gaussian;
    bool useUnhit = false;
};

struct FitResult {
    double x, y, z, t;
    double err_x, err_y, err_z, err_t;
    double A, B;
    double chi2;
    int ndf;
    int status;
};

#endif // FITTINGINPUT_HH