/**
 * @file fittinginput.hh
 * @brief フィッティングに必要な定数、データ構造、設定構造体を定義するヘッダーファイル
 *
 * このファイルには以下の要素が含まれます：
 * 1. 物理定数 (光速など)
 * 2. 検出器ジオメトリ定義 (PMT座標、向き)
 * 3. 補正パラメータ (TimeWalk, TimeOffset, 電荷モデル係数)
 * 4. 入力データの構造体 (PMTData)
 * 5. 解析設定用の列挙型と構造体 (FitConfig)
 *
 * @author Gemini (Modified based on user request)
 * @date 2025-01-13
 */

#ifndef FITTINGINPUT_HH
#define FITTINGINPUT_HH

#include <vector>
#include <cmath>
#include <string>

// =========================================================
// 物理定数・PMT補正値
// =========================================================
const double C_LIGHT = 29.970255; // 光速 [cm/ns] (空気中の屈折率 n=1.0003 を考慮)

// PMTごとの時間補正値 (ns) : ケーブル遅延やT0オフセット
// t_expected の計算に使用されます: t_exp = t0 + tof + TW + CORRECTION
const double TIME_CORRECTION_VAL[4] = {190.229, 213.495, 200.0, 200.0};/////まだおかしい
const double TIME_CORRECTION_ERR[4] = {0.0, 0.0, 0.0, 0.0};

// =========================================================
// TimeWalk (TW) および 時間分解能 (Sigma_t) のパラメータ
// =========================================================
// 関数形: f(q) = c0 * q^{-1/2} + c1 + c2 * q + c3 * q^2
// 配列の並び: {c0, c1, c2, c3}

// TimeWalk補正係数 [ch][param]
const double TW_PARAMS[4][4] = {
    {19.8842, 193.657 - TIME_CORRECTION_VAL[0], -0.00556374, 0.00000195876}, // CH0
    {19.5672, 216.73 - TIME_CORRECTION_VAL[1], -0.00564927, 0.00000211823}, // CH1
    {74.3989, 210.006 - TIME_CORRECTION_VAL[2], 0.0423605, -0.000065808}, // CH2//////ここだけおかしい
    {0.0, 0.0, 0.0, 0.0}  // CH3/////ここも
};

// 時間分解能 (Sigma_t) 係数 [ch][param]
const double SIGMA_T_PARAMS[4][4] = {
    {3.58786, 0.00257897, 0.000733425, -0.000000243}, // CH0: 1.0 ns constant
    {3.87657, -0.060639, 0.000770616, -0.000000204931}, // CH1
    {0.0, 1.0, 0.0, 0.0}, // CH2
    {0.0, 1.0, 0.0, 0.0}  // CH3
};



const double CHARGE_ANGULAR_PARAMS[4][8] = {
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH0
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH1
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH2
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}  // CH3
};


// --- Model: FuncF 用パラメータ (PMT半径 28.5cm) ---
// 式: mu = A * c0 * (1 - sqrt(1 - (28.5/r)^2)) * epsilon
// 配列: {c0} (各CHごとのスケール因子)
    // ====================================================================================================
    // フィット結果 (r_pmt = 28.5 cm, z_center = 52.0 cm)
    // ====================================================================================================
    //  PMT_num  n_data  r_pmt  z_pmt_center        f_c0  f_c0_err  f_chi2_ndf         g_c0   g_c0_err   g_chi2_ndf
    //        1      21   28.5          52.0 1735.120850  0.517103 1000.992862 7.432712e+05 222.020672  3584.302711
    //        2      31   28.5          52.0 1797.513582  0.352741 1118.445104 7.866198e+05 154.923384  7346.081773
    //        3      34   28.5          52.0 2295.990798  0.407062 5512.320539 1.001118e+06 177.966805 10663.475502
    //        4      32   28.5          52.0 2090.702270  0.463223  559.679816 9.114506e+05 202.136797  1812.155065
    // ====================================================================================================
const double CHARGE_PARAMS_FUNC_F[4] = {
    1735.120850, // CH0
    1797.513582, // CH1
    2295.990798, // CH2
    2090.702270  // CH3
};


const double CHARGE_PARAMS_FUNC_G[4] = {
    645120.250645, // CH0
    667116.140467, // CH1
    857546.548873, // CH2
    770455.592757  // CH3
};


// =========================================================
// PMT座標・形状定義 (4 PMTs)
// =========================================================
// X, Y座標は表面中心・半球中心で共通 (軸対称と仮定)
const double PMT_XY_POS[4][2] = {
    {-35.0,  35.0}, // PMT#1 (CH0)
    { 35.0,  35.0}, // PMT#2 (CH1)
    {-35.0, -35.0}, // PMT#3 (CH2)
    { 35.0, -35.0}  // PMT#4 (CH3)
};

// 基準となる表面の高さ (cm)
// ※ 中心座標はここから半径 r_pmt を引いて計算される
const double PMT_SURFACE_Z = 80.5;

// モデルごとのPMT半径定義 (cm)
const double PMT_RADIUS_F = 28.5; // func_f 用
const double PMT_RADIUS_G = 23.5; // func_g 用

// PMTの向き (全PMT共通でZ軸方向を向いていると仮定)
const double PMT_DIR[3] = {0.0, 0.0, 1.0}; 

// 便宜上の旧互換定義 (readDataなどで使用される表面中心座標)
const double PMT_POSITIONS[4][3] = {
    {-35.0,  35.0, PMT_SURFACE_Z},
    { 35.0,  35.0, PMT_SURFACE_Z},
    {-35.0, -35.0, PMT_SURFACE_Z},
    { 35.0, -35.0, PMT_SURFACE_Z}
};

// =========================================================
// 関数プロトタイプ
// =========================================================
// チャンネルと電荷を受け取り、パラメータ配列に基づいて値を計算する関数
double CalcParametricValue(int ch, double charge, const double params[4][4]);

// 以下、旧来の関数（必要に応じて中身を書き換え予定だが今回は上記関数で代替）
double GetEMG_Sigma(int ch, double charge);
double GetEMG_Tau(int ch, double charge);

// =========================================================
// データ構造体
// =========================================================
struct PMTData {
    int eventID;
    int ch;
    double time;
    double charge;
    double x, y, z; // 読み込み時の座標 (通常は表面中心が入る)
    double dir_x, dir_y, dir_z;
    bool isHit;
};

struct PedestalData {
    double hgain_mean;
    double lgain_mean;
};

// =========================================================
// フィッティング設定
// =========================================================

/**
 * @enum ChargeChi2Type
 * @brief 電荷分布のChi2計算モデル
 */
enum class ChargeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    BakerCousins,   // 2 * (mu - n + n*ln(n/mu))
    None            // 電荷情報を使用しない
};

/**
 * @enum ChargeModelType
 * @brief 電荷の期待値モデル
 * @note 古いモデルは削除され、FuncF, FuncGのみとなりました。
 */
enum class ChargeModelType {
    FuncF,          // r=28.5, 立体角近似式
    FuncG           // r=23.5, 1/r^2
};

/**
 * @enum TimeChi2Type
 * @brief 時間分布のChi2計算モデル
 */
enum class TimeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    EMG,            // EMG分布 (-ln L)
    Goodness,       // SK風Goodness
    None            // 時間情報を使用しない
};

struct FitConfig {
    ChargeChi2Type chargeType = ChargeChi2Type::Gaussian;
    ChargeModelType chargeModel = ChargeModelType::FuncF; // デフォルト
    TimeChi2Type timeType = TimeChi2Type::Gaussian;
    bool useUnhit = false;
};

struct FitResult {
    double x, y, z, t;
    double err_x, err_y, err_z, err_t;
    double A, B;
    double chi2;
    int ndf;
    int status;
};

#endif // FITTINGINPUT_HH



/**
 * @file fittinginput.hh
 * @brief フィッティングに必要な定数、データ構造、設定構造体を定義するヘッダーファイル
 *
 * このファイルには以下の要素が含まれます：
 * 1. 物理定数 (光速など)
 * 2. 検出器ジオメトリ定義 (PMT座標、向き)
 * 3. 補正パラメータ (TimeWalk, TimeOffset, 電荷モデル係数)
 * 4. 入力データの構造体 (PMTData)
 * 5. 解析設定用の列挙型と構造体 (FitConfig)
 *
 * @author Gemini (Modified based on user request)
 * @date 2025-01-08
 */

#ifndef FITTINGINPUT_HH
#define FITTINGINPUT_HH

#include <vector>
#include <cmath>
#include <string>

// time csv files ============================================================================================================
// min_val = TIME_CORRECTION_VAL 
// MeanがTimewalk、RMSが時間分解能のフィットに使用されるパラメータに対応
    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 0,Gamma,-2.97248e+11,1902.59,1.63159e+11,5.54198e+10,-7.86906e+09,5.45736e+10,1.27231e+08,5.48893e+10,4.05153e+07,11,-8.83371e+10,1.64538e+11,1.53786
    // 0,GausAmp,-48881.5,127.58,29985.8,49.1926,-28.3817,0.0611268,0.0082181,2.06855e-05,111917,24,-9475.15,0,1.53786
    // 0,GausMu,19.6289,0.0162468,193.683,0.00251109,-0.0054264,6.85525e-06,1.92106e-06,5.31769e-09,120552,16,190.37,0,1442.4
    // 0,GausSigma,2.64048,0.00659496,0.106235,0.00119835,0.000178009,3.59899e-06,-2.89345e-08,2.81415e-09,2044.75,16,0.304737,0,419.347
    // 0,Mean,19.8842,0.0170032,193.657,0.00270831,-0.00556375,7.47335e-06,1.95876e-06,5.75591e-09,107397,16,190.23,0,1442.4
    // 0,Mu,7.43826,0.00684796,196.653,0.00153344,-0.0309401,1.3014e-06,6.50566e-06,4.50743e-10,1.18948e+06,11,160.019,0.000963488,2380.4
    // 0,Peak,8.81294,0.021167,196.783,0.00475129,-0.0319055,2.03357e-05,7.06731e-06,8.9119e-09,15528,11,160.959,0,2260.16
    // 0,RMS,3.58786,0.00723263,0.0025788,0.00133038,0.000733431,4.33215e-06,-2.4322e-07,3.60742e-09,10815.8,16,0.393235,0,199.558
    // 0,Sigma,0.665964,0.000741858,0.586454,0.000303666,-0.00614516,6.96973e-06,3.90689e-06,4.11964e-09,5.18883e+06,11,-1.80625,0.00784484,788.377
    // 0,TTS,6.96942,0.0213118,-0.147895,0.0048441,0.00608534,1.95824e-05,-2.19157e-06,8.60325e-09,4856.74,11,1.10022,0,71.43
    // 0,Tau,6.45372,0.0029152,-1.00634,0.000407207,0.00550268,1.00038e-06,-2.0886e-06,5.71144e-10,181140,11,-0.368193,0,2538.42

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 1,Gamma,1.14075e+10,8.60828e+06,5.80783e+08,349932,-2.34661e+13,8.21207e+09,8.73611e+12,1.5411e+08,5.63769e+07,13,-1.39663e+13,0,1.79477
    // 1,GausAmp,-52202.6,137.679,30986.1,52.4106,-32.4405,0.0643751,0.0102357,2.11635e-05,123700,24,-8038.28,0,1.79477
    // 1,GausMu,19.2141,0.0193678,216.759,0.00303062,-0.00552248,8.66071e-06,2.06143e-06,7.30099e-09,72137.1,12,213.65,0,1206.35
    // 1,GausSigma,2.56711,0.0068221,0.100237,0.00130237,0.000182068,4.25517e-06,-3.5941e-08,3.72584e-09,2896.62,14,0.295619,0,414.138
    // 1,Mean,19.5672,0.0197772,216.73,0.00318416,-0.00564927,9.44224e-06,2.11823e-06,8.26361e-09,57737.2,12,213.561,0,1206.35
    // 1,Mu,19.3633,0.0159084,217.623,0.00248714,-0.028414,1.83272e-06,5.99612e-06,4.5879e-10,4.26924e+06,13,184.359,0.00102911,2376.33
    // 1,Peak,16.1198,0.0212362,218.537,0.0039881,-0.0294556,1.25358e-05,6.41677e-06,5.36177e-09,298378,13,185.07,0,2300.89
    // 1,RMS,3.87657,0.00801372,-0.0606388,0.00148629,0.000770614,5.24429e-06,-2.04928e-07,5.00895e-09,8101.8,14,0.3594,0,199.294
    // 1,Sigma,0.567919,0.000649625,0.595513,0.000269288,-0.00625425,6.18503e-06,4.61585e-06,4.20395e-09,1.00653e+07,13,-1.50123,0.00929052,679.213
    // 1,TTS,7.16692,0.0205389,-0.241254,0.00425874,0.0057971,1.43513e-05,-2.12198e-06,6.21276e-09,10885.5,13,0.93839,0,2539.41
    // 1,Tau,8.85492,0.00409106,-1.43884,0.000532892,0.00740935,1.08274e-06,-3.2484e-06,6.48678e-10,1.62525e+06,13,-3.39536,0.000510264,2539.41

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 2,Gamma,-3.18479e+15,7.17777e+12,1.02512e+16,2.31035e+13,-3.50325e+15,7.89541e+12,2.97696e+14,6.7093e+11,4.72391e+07,11,-1.3792e+15,0,5.68671
    // 2,GausAmp,-56353,149.172,32437.7,54.254,-30.4397,0.0627617,0.00843304,1.98912e-05,122273,24,-9696.88,0,1.79342
    // 2,GausMu,19.035,0.0171755,220.41,0.00260978,-0.00475051,6.60352e-06,1.55778e-06,4.6165e-09,108440,15,217.272,0,1573.7
    // 2,GausSigma,2.64227,0.00696015,0.0973153,0.00119871,0.000182438,3.20551e-06,-1.76233e-08,2.23726e-09,3740.74,15,0.299575,0,394.622
    // 2,Mean,19.2426,0.0173597,220.392,0.00273355,-0.00496091,7.08632e-06,1.59961e-06,5.01004e-09,89502.3,15,217.03,0,1597.76
    // 2,Mu,14.6184,1,221.533,1.00209,-0.0126188,1.00214,-2.05122e-06,1.00214,2.95318e+06,11,176.457,3.47344e+06,2543.52
    // 2,Peak,11.1175,0.0214288,222.357,0.0046204,-0.0172871,2.54264e-05,8.38212e-07,1.0971e-08,414883,11,184.03,0.0252531,2543.52
    // 2,RMS,3.65513,0.0077786,0.001132,0.00140131,0.000849763,4.22716e-06,-2.34409e-07,3.2028e-09,12513.1,15,0.418925,0,178.542
    // 2,Sigma,5.76789e+08,405962,-9.19536e+07,64048.9,76191.3,54.0336,-18.1941,0.0131397,2.48965e+06,11,-3.76089e+07,27541.9,265.893
    // 2,TTS,7.3334,0.0238083,-0.350955,0.00572208,0.0091899,3.41278e-05,-3.44737e-06,1.44196e-08,14312.2,11,0.866436,0,2543.52
    // 2,Tau,3.9762e+08,348785,-1.00858e+08,82177.6,889477,698.066,-441.087,0.348889,4.12992e+06,11,-6.84181e+08,573733,2543.52

    // ch,graph_type,p0,p0_err,p1,p1_err,p2,p2_err,p3,p3_err,chi2,ndf,min_val,min_err,at_charge
    // 3,Gamma,9.80067e+10,2.61576e+13,-9.06968e+17,2.18476e+15,-2.12503e+20,4.12005e+16,4.50962e+21,1.7207e+17,1.73343e+07,8,1.59246e+22,0,1.90292
    // 3,GausAmp,-48535.2,130.035,28362.3,48.2055,-25.6037,0.0578397,0.00678732,1.8773e-05,73241,22,-6870.53,0,1.90292
    // 3,GausMu,18.66,0.0182492,246.961,0.00294303,-0.00550003,8.1478e-06,1.78382e-06,6.1501e-09,80593.3,15,243.193,0,1583.16
    // 3,GausSigma,2.74712,0.00797341,0.126977,0.00141738,0.000133321,3.98505e-06,7.79254e-08,2.9565e-09,4122.62,15,0.329787,0,372.153
    // 3,Mean,18.7813,0.0190264,246.941,0.0032899,-0.00594045,9.37393e-06,1.83122e-06,6.90607e-09,61810.6,15,242.587,0,1659.91
    // 3,Mu,7.85131,0.00903362,249.461,0.00236698,-0.027871,6.74708e-06,5.23753e-06,2.95963e-09,221152,8,212.623,0.00655169,2533.76
    // 3,Peak,10.0401,0.0262667,249.337,0.00673509,-0.0263838,3.70715e-05,4.76355e-06,1.59542e-08,14061.4,8,213.267,0,2533.76
    // 3,RMS,3.59905,0.00880967,0.0923478,0.00174692,0.00125586,5.72697e-06,-2.98823e-07,4.48469e-09,9549.26,15,0.566168,0,132.751
    // 3,Sigma,7.16042e+08,241454,-1.49307e+08,14487.6,127470,2.85674,-30.216,0.00319919,1.1429e+06,8,-7.44645e+07,0,213.766
    // 3,TTS,6.76826,0.0319104,-0.0125329,0.00889587,0.00871357,4.11186e-05,-3.2036e-06,1.77118e-08,5883.31,8,1.36964,0,54.7085
    // 3,Tau,1.53515,0.00625523,1.35509,0.0034182,-0.0497263,0.000105495,2.61584e-05,5.38866e-08,1.14402e+06,8,-22.2271,0.0634662,950.984
// time csv files ============================================================================================================

// =========================================================
// 物理定数・PMT補正値
// =========================================================
const double C_LIGHT = 29.970255; // 光速 [cm/ns] (空気中の屈折率 n=1.0003 を考慮)

// PMTごとの時間補正値 (ns) : ケーブル遅延やT0オフセット
// t_expected の計算に使用されます: t_exp = t0 + tof + TW + CORRECTION
const double TIME_CORRECTION_VAL[4] = {190.23, 213.561, 217.03, 242.587};
const double TIME_CORRECTION_ERR[4] = {0.0, 0.0, 0.0, 0.0};

// =========================================================
// TimeWalk (TW) および 時間分解能 (Sigma_t) のパラメータ
// =========================================================
// 関数形: f(q) = c0 * q^{-1/2} + c1 + c2 * q + c3 * q^2
// 配列の並び: {c0, c1, c2, c3}

// TimeWalk補正係数 [ch][param]
// 上のCSVデータから取得したフィットパラメータを使用 (Meanのデータからc0~c3)
const double TW_PARAMS[4][4] = {
    {19.8842, 193.657, -0.00556375, 1.95876e-06}, // CH0
    {19.5672, 216.73, -0.00564927, 2.11823e-06}, // CH1
    {19.2426, 220.392, -0.00496091, 1.59961e-06}, // CH2
    {18.7813, 246.941, -0.00594045, 1.83122e-06}  // CH3
};

// 時間分解能 (Sigma_t) 係数 [ch][param]
// 上のCSVデータから取得したフィットパラメータを使用 (RMSのデータからc0~c3)
const double SIGMA_T_PARAMS[4][4] = {
    {3.58786, 0.0025788, 0.000733431, -2.4322e-07}, // CH0
    {3.87657, -0.0606388, 0.000770614, -2.04928e-07}, // CH1
    {3.65513, 0.001132, 0.000849763, -2.34409e-07}, // CH2
    {3.59905, 0.0923478, 0.00125586, -2.98823e-07}  // CH3
};

// =========================================================
// [New] 電荷モデル用パラメータ
// =========================================================

// --- Model: FuncF 用パラメータ (PMT半径 28.5cm) ---
// 式: mu = A * c0 * (1 - sqrt(1 - (28.5/r)^2)) * epsilon
// 配列: {c0} (各CHごとのスケール因子)

    // ====================================================================================================
    // フィット結果 (r_pmt = 28.5 cm, z_center = 52.0 cm)
    // ====================================================================================================
    //  PMT_num  n_data  r_pmt  z_pmt_center        f_c0  f_c0_err  f_chi2_ndf         g_c0   g_c0_err   g_chi2_ndf
    //        1      21   28.5          52.0 1735.120850  0.517103 1000.992862 7.432712e+05 222.020672  3584.302711
    //        2      31   28.5          52.0 1797.513582  0.352741 1118.445104 7.866198e+05 154.923384  7346.081773
    //        3      34   28.5          52.0 2295.990798  0.407062 5512.320539 1.001118e+06 177.966805 10663.475502
    //        4      32   28.5          52.0 2090.702270  0.463223  559.679816 9.114506e+05 202.136797  1812.155065
    // ====================================================================================================
const double CHARGE_PARAMS_FUNC_F[4] = {
    1735.120850, // CH0
    1797.513582, // CH1
    2295.990798, // CH2
    2090.702270  // CH3
};

// 角度依存性: epsilon_i(cos_a) = c0 + c1*x + ... + c7*x^7
// 配列: {c0, c1, c2, c3, c4, c5, c6, c7}

    // ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    // PMT ALL (f関数)
    // ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    // データ点数: 725
    // χ²/ndf: 3126.223645
    // 制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
    // 注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング
    // 【パラメータ (c0~c7)】
    // パラメータ              値         誤差
    //    c0    65.47994439 3.1455e+02
    //    c1  -666.94438919 1.0306e+01
    //    c2  2807.20062460 4.9649e+01
    //    c3 -6285.95641483 1.2969e+02
    //    c4  8080.52927610 1.9872e+02
    //    c5 -5937.98141797 1.7894e+02
    //    c6  2289.15307553 8.7807e+01
    //    c7  -350.48069863 1.8139e+01
const double CHARGE_ANGULAR_PARAMS_FUNC_F[4][8] = {
    {65.47994439, -666.94438919, 2807.20062460, -6285.95641483, 8080.52927610, -5937.98141797, 2289.15307553, -350.48069863}, // CH0
    {65.47994439, -666.94438919, 2807.20062460, -6285.95641483, 8080.52927610, -5937.98141797, 2289.15307553, -350.48069863}, // CH1
    {65.47994439, -666.94438919, 2807.20062460, -6285.95641483, 8080.52927610, -5937.98141797, 2289.15307553, -350.48069863}, // CH2
    {65.47994439, -666.94438919, 2807.20062460, -6285.95641483, 8080.52927610, -5937.98141797, 2289.15307553, -350.48069863}  // CH3
};


// --- Model: FuncG 用パラメータ (PMT半径 23.5cm) ---
// 式: mu = A * c0 / r^2 * epsilon
// 配列: {c0} (各CHごとのスケール因子)

    // ====================================================================================================
    // フィット結果 (r_pmt = 23.5 cm, z_center = 57.0 cm)
    // ====================================================================================================
    //  PMT_num  n_data  r_pmt  z_pmt_center        f_c0  f_c0_err   f_chi2_ndf          g_c0   g_c0_err  g_chi2_ndf
    //        1      18   23.5          57.0 2204.395240  0.701365  1891.100905 645120.250645 205.020160  555.259040
    //        2      27   23.5          57.0 2224.514717  0.451112  4811.822217 667116.140467 135.013696 1044.764880
    //        3      30   23.5          57.0 2864.269135  0.526463 12437.520986 857546.548873 157.081842 5431.292321
    //        4      28   23.5          57.0 2590.526802  0.589778  5321.221103 770455.592757 174.802632  368.262852
    // ====================================================================================================
const double CHARGE_RADIAL_PARAMS_FUNC_G[4] = {
    645120.250645, // CH0
    667116.140467, // CH1
    857546.548873, // CH2
    770455.592757  // CH3
};

// 角度依存性: epsilon_i(cos_a) = c0 + c1*x + ... + c7*x^7
// 配列: {c0, c1, c2, c3, c4, c5, c6, c7}

    // ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    // PMT ALL (g関数)
    // ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    // データ点数: 725
    // χ²/ndf: 3163.112769
    // 制約条件（Σcᵢ）: 1.000000 (1.0になるべき)
    // 注：方法Bでは制約を組み込んだ7個のパラメータでフィッティング
    // 【パラメータ (c0~c7)】
    // パラメータ              値         誤差
    //    c0    40.51780628 1.6995e+02
    //    c1  -449.34780790 4.6484e+00
    //    c2  2065.26720812 2.3850e+01
    //    c3 -5051.57922468 6.5886e+01
    //    c4  7125.87949227 1.0611e+02
    //    c5 -5805.73602586 9.9870e+01
    //    c6  2530.46478294 5.0972e+01
    //    c7  -454.46623118 1.0905e+01
const double CHARGE_ANGULAR_PARAMS_FUNC_G[4][8] = {
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH0
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH1
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}, // CH2
    {40.51780628, -449.34780790, 2065.26720812, -5051.57922468, 7125.87949227, -5805.73602586, 2530.46478294, -454.46623118}  // CH3
};


// =========================================================
// PMT座標・形状定義 (4 PMTs)
// =========================================================
// X, Y座標は表面中心・半球中心で共通 (軸対称と仮定)
const double PMT_XY_POS[4][2] = {
    {-35.0,  35.0}, // PMT#1 (CH0)
    { 35.0,  35.0}, // PMT#2 (CH1)
    {-35.0, -35.0}, // PMT#3 (CH2)
    { 35.0, -35.0}  // PMT#4 (CH3)
};

// 基準となる表面の高さ (cm)
// ※ 中心座標はここから半径 r_pmt を引いて計算される
const double PMT_SURFACE_Z = 80.5;

// モデルごとのPMT半径定義 (cm)
const double PMT_RADIUS_F = 28.5; // func_f 用
const double PMT_RADIUS_G = 23.5; // func_g 用

// PMTの向き (全PMT共通でZ軸方向を向いていると仮定)
const double PMT_DIR[3] = {0.0, 0.0, 1.0}; 

// 便宜上の旧互換定義 (readDataなどで使用される表面中心座標)
const double PMT_POSITIONS[4][3] = {
    {-35.0,  35.0, PMT_SURFACE_Z},
    { 35.0,  35.0, PMT_SURFACE_Z},
    {-35.0, -35.0, PMT_SURFACE_Z},
    { 35.0, -35.0, PMT_SURFACE_Z}
};

// =========================================================
// 関数プロトタイプ
// =========================================================
// チャンネルと電荷を受け取り、パラメータ配列に基づいて値を計算する関数
double CalcParametricValue(int ch, double charge, const double params[4][4]);

// 以下、旧来の関数（必要に応じて中身を書き換え予定だが今回は上記関数で代替）
double GetEMG_Sigma(int ch, double charge);
double GetEMG_Tau(int ch, double charge);

// =========================================================
// データ構造体
// =========================================================
struct PMTData {
    int eventID;
    int ch;
    double time;
    double charge;
    double x, y, z; // 読み込み時の座標 (通常は表面中心が入る)
    double dir_x, dir_y, dir_z;
    bool isHit;
};

struct PedestalData {
    double hgain_mean;
    double lgain_mean;
};

// =========================================================
// フィッティング設定
// =========================================================

/**
 * @enum ChargeChi2Type
 * @brief 電荷分布のChi2計算モデル
 */
enum class ChargeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    BakerCousins,   // 2 * (mu - n + n*ln(n/mu))
    None            // 電荷情報を使用しない
};

/**
 * @enum ChargeModelType
 * @brief 電荷の期待値モデル
 * @note 古いモデルは削除され、FuncF, FuncGのみとなりました。
 */
enum class ChargeModelType {
    FuncF,          // r=28.5, 立体角近似式
    FuncG           // r=23.5, 1/r^2
};

/**
 * @enum TimeChi2Type
 * @brief 時間分布のChi2計算モデル
 */
enum class TimeChi2Type {
    Gaussian,       // ((obs - exp)^2 / sigma^2)
    EMG,            // EMG分布 (-ln L)
    Goodness,       // SK風Goodness
    None            // 時間情報を使用しない
};

struct FitConfig {
    ChargeChi2Type chargeType = ChargeChi2Type::Gaussian;
    ChargeModelType chargeModel = ChargeModelType::FuncF; // デフォルト
    TimeChi2Type timeType = TimeChi2Type::Gaussian;
    bool useUnhit = false;
};

struct FitResult {
    double x, y, z, t;
    double err_x, err_y, err_z, err_t;
    double A, B;
    double chi2;
    int ndf;
    int status;
};

#endif // FITTINGINPUT_HH